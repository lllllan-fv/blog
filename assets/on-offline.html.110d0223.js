import{_ as n}from"./plugin-vue_export-helper.21dcd24c.js";import{d as s}from"./app.af53d2d3.js";var a="/assets/image-20220528000216977.66491d80.png";const p={},e=s(`<h2 id="\u4E0A\u4E0B\u7EBF\u901A\u77E5" tabindex="-1"><a class="header-anchor" href="#\u4E0A\u4E0B\u7EBF\u901A\u77E5" aria-hidden="true">#</a> \u4E0A\u4E0B\u7EBF\u901A\u77E5</h2><p>\uFF08\u6DFB\u52A0 <code>user.go/</code> \u51FD\u6570\uFF09\u4E24\u4E2A\u65B9\u6CD5\u4E2D\u5206\u522B\u9700\u8981\u5F80 UserMap \u4E2D\u6DFB\u52A0\u548C\u5220\u9664\u7528\u6237\uFF0C\u6BD5\u7ADF Map \u9700\u8981\u7EF4\u62A4\u7684\u662F\u5728\u7EBF\u7528\u6237\u7684\u5217\u8868\u3002</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Online \u7528\u6237\u4E0A\u7EBF</span>
<span class="token comment">// - \u7528\u6237\u52A0\u5165 server.UserMap</span>
<span class="token comment">// - \u5BF9\u6240\u6709\u7528\u6237\u8FDB\u884C\u5E7F\u64AD\u63D0\u793A</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>this <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">Online</span><span class="token punctuation">(</span>server <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	server<span class="token punctuation">.</span>mapLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	server<span class="token punctuation">.</span>UserMap<span class="token punctuation">[</span>this<span class="token punctuation">.</span>Addr<span class="token punctuation">]</span> <span class="token operator">=</span> this
	server<span class="token punctuation">.</span>mapLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	server<span class="token punctuation">.</span><span class="token function">BroadCast</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> <span class="token string">&quot;\u5DF2\u4E0A\u7EBF&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Offline \u7528\u6237\u4E0B\u7EBF</span>
<span class="token comment">// - \u7528\u6237\u79FB\u51FA server.UserMap</span>
<span class="token comment">// - \u5BF9\u6240\u6709\u7528\u6237\u8FDB\u884C\u5E7F\u64AD\u63D0\u793A</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>this <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">Offline</span><span class="token punctuation">(</span>server <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	server<span class="token punctuation">.</span>mapLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">delete</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>UserMap<span class="token punctuation">,</span> this<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span>
	server<span class="token punctuation">.</span>mapLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	server<span class="token punctuation">.</span><span class="token function">BroadCast</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> <span class="token string">&quot;\u5DF2\u4E0B\u7EBF&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="\u89E6\u53D1\u4E0A\u7EBF\u901A\u77E5" tabindex="-1"><a class="header-anchor" href="#\u89E6\u53D1\u4E0A\u7EBF\u901A\u77E5" aria-hidden="true">#</a> \u89E6\u53D1\u4E0A\u7EBF\u901A\u77E5</h3><p>\uFF08\u8865\u5145 <code>server.go/Handler()</code> \u51FD\u6570\uFF09\u5728\u6BCF\u4E2A\u8FDE\u63A5\u8BF7\u6C42\u63A5\u5165\u7684\u65F6\u5019\uFF0C\u7531 server \u53BB\u89E6\u53D1\u7528\u6237\u7684\u4E0A\u7EBF\u901A\u77E5</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Handler \u5904\u7406\u6BCF\u4E00\u4E2A\u8FDE\u63A5\u8BF7\u6C42</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>this <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">Handler</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	user <span class="token operator">:=</span> <span class="token function">NewUser</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>

	<span class="token comment">// \u5F53\u524D\u8FDE\u63A5\u7684\u7EC8\u7AEF\u6253\u5370\u4FE1\u606F</span>
	conn<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;\u5EFA\u7ACB\u8FDE\u63A5...\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// \u4E0A\u7EBF\u52A0\u5165 UserMap</span>
	user<span class="token punctuation">.</span><span class="token function">Online</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span>

	<span class="token comment">// server \u76D1\u542C\u8BE5\u7528\u6237\u7684\u8F93\u5165</span>
	<span class="token keyword">go</span> user<span class="token punctuation">.</span><span class="token function">ListenWrite</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="\u89E6\u53D1\u4E0B\u7EBF\u901A\u77E5" tabindex="-1"><a class="header-anchor" href="#\u89E6\u53D1\u4E0B\u7EBF\u901A\u77E5" aria-hidden="true">#</a> \u89E6\u53D1\u4E0B\u7EBF\u901A\u77E5</h3><p>\uFF08\u8865\u5145 <code>user.go/ListenWrite()</code> \u51FD\u6570\uFF09\u5728\u76D1\u542C\u7528\u6237\u8F93\u5165\u7684\u534F\u7A0B\u5F53\u4E2D\uFF0C\u5F53\u8F93\u5165\u5B57\u7B26\u6570\u4E3A\u96F6\u65F6\uFF0C\u8868\u793A\u7528\u6237\u4E0D\u518D\u8F93\u5165\u3001\u4E5F\u5C31\u610F\u5473\u7740\u7528\u6237\u7684\u4E0B\u7EBF\uFF0C\u5728\u6B64\u5904\u53BB\u89E6\u53D1\u4E0B\u7EBF\u901A\u77E5</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// ListenWrite \u76D1\u542C\u7528\u6237\u8F93\u5165</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>this <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token function">ListenWrite</span><span class="token punctuation">(</span>server <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		n<span class="token punctuation">,</span> err <span class="token operator">:=</span> this<span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>

		<span class="token comment">// \u7528\u6237\u4E0B\u7EBF\uFF0C\u4E0D\u518D\u53D1\u9001\u6D88\u606F</span>
		<span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			this<span class="token punctuation">.</span><span class="token function">Offline</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>

		<span class="token operator">...</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="\u6267\u884C\u6D4B\u8BD5" tabindex="-1"><a class="header-anchor" href="#\u6267\u884C\u6D4B\u8BD5" aria-hidden="true">#</a> \u6267\u884C\u6D4B\u8BD5</h2><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>go build -o server main.go server.go user.go
./server
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">nc</span> <span class="token number">127.0</span>.0.1 <span class="token number">8888</span>
^C
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">nc</span> <span class="token number">127.0</span>.0.1 <span class="token number">8888</span>
^C
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">nc</span> <span class="token number">127.0</span>.0.1 <span class="token number">8888</span>
^C
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="`+a+'" alt="image-20220528000216977" loading="lazy"></p>',15);function t(c,o){return e}var r=n(p,[["render",t],["__file","on-offline.html.vue"]]);export{r as default};
